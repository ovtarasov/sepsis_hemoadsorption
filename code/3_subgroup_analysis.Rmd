---
title: "Subgroup analysis"
author: "Гладышев Никита Сергеевич"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
library(survival)
library(survminer)
library(dplyr)
library(broom)
library(ggplot2)
library(splines)

```

# 4.1 Загрузка и подготовка данных к анализу

```{r}
analysis_data <- readRDS("C:/Users/user-1/Downloads/joint_sepsis.rds") %>%
  filter(shock_T0 == TRUE) %>%
  mutate(unique_patient_id = paste(study_id, study_patient_id, sep = "_"),
         treatment = combined_efferon)

analysis_data <- analysis_data %>%
  mutate(time_point = as.character(time_point))

data_T0 <- analysis_data %>% filter(time_point == "0") %>% select(-time_point)
data_T3 <- analysis_data %>% filter(time_point == "3") %>% select(-time_point)

data_T3 <- data_T3 %>% 
  mutate (SOFA_T3 = SOFA) %>% 
  select (unique_patient_id, SOFA_T3)

analysis_data <- data_T0 %>%
  left_join(data_T3, by = "unique_patient_id") %>%
  mutate(across(starts_with("infection_"), ~ as.numeric(as.character(.))))

analysis_data <- analysis_data %>%
  mutate(
    sex = as.factor(sex),
    treatment = as.factor(treatment),
    SI_CISCIO = as.numeric(SI_CISCIO)) %>% 
  mutate(across(contains("infection"), ~ as.factor(ifelse(. > 0, "Yes", "No"))))
```

# 4.2 Линейная модель по всем переменным

```{r}

base_covariates <- c("SOFA", "NLR", "age", "SI_CISCIO", "sex")
vars <- c("weight", "height", "BMI", "APACHE2", "MAP", "PF_ratio", "lactate", "VIS2020", "WBC", "NEU", "LYM", "PLT", "SII", "aPTT", "fibrinogen", "creatinine", "bilirubin_total", "CRP", "PCT", "IL_6", "infection_g_negative", "infection_g_positive", "infection_virus", "infection_fungi", "hospt_quality_level", "source_cat","SI_CISCIO")


run_lm_sofa <- function(var, data) {
  formula <- as.formula(paste("SOFA_T3 ~", paste(base_covariates, collapse = " + "), 
                              "+ treatment *", var))
  fit <- lm(formula, data = data)
  return(tidy(fit))
}

lm_results <- lapply(vars, function(v) run_lm_sofa(v, analysis_data))

summary (lm_results)

lm_results_df <- bind_rows(setNames(lm_results, vars), .id = "model_var")


```

# 4.3 Поправка на множественные сравнения и отбор переменных взаимодействия

```{r}

lm_results_df <- lm_results_df %>%
  mutate(p.adj = p.adjust(p.value, method = "BH"))

significant_vars_sofa <- lm_results_df %>%
  filter(grepl(":", term)) %>%
#  filter(p.adj < 0.05) %>%
  arrange(p.adj)

significant_vars_sofa <- significant_vars_sofa %>%
    mutate(conf.low = estimate - 1.96 * std.error,
           conf.high = estimate + 1.96 * std.error)

```


# 4.4 Форестплот

```{r, fig.height=7}
ggplot(significant_vars_sofa, aes(x = term, y = estimate, ymin = conf.low, ymax = conf.high)) +
  geom_pointrange(aes(color = estimate)) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  coord_flip() +
  labs(
    x = "Предиктор",
    y = "Regression Coefficient (95% CI)"
  ) +
  theme_minimal() +
  scale_color_gradient2(low = "blue", mid = "gray", high = "red", midpoint = 0)
```

# 4.5 Анализ сплайнов

```{r}

unique_counts <- sapply(analysis_data[vars_numeric], function(x) length(unique(x)))

vars_numeric_spline <- names(unique_counts[unique_counts >= 4])

problem_vars <- c("hospt_quality_level")  
vars_numeric_spline <- setdiff(vars_numeric_spline, problem_vars)

analysis_data_spline <- analysis_data %>%
  mutate(across(all_of(vars_numeric_spline), ~ ns(., df = 2), .names = "spline_{.col}"))

print(vars_numeric_spline)


run_lm_sofa <- function(var, data) {
  formula <- as.formula(paste("SOFA_T3 ~", paste(base_covariates, collapse = " + "), 
                              "+ treatment *", var))
  fit <- lm(formula, data = data)
  return(tidy(fit))
}


lm_spline_results <- lapply(vars_numeric_spline, function(v) run_lm_sofa(v, analysis_data_spline))

lm_spline_df <- bind_rows(setNames(lm_spline_results, vars_numeric_spline), .id = "model_var")

lm_spline_df <- lm_spline_df %>%
  mutate(p.adj = p.adjust(p.value, method = "BH"))

significant_spline_vars <- lm_spline_df %>%
  filter(grepl(":", term)) %>%
#  filter(p.adj < 0.05) %>%
  arrange(p.adj)

print(significant_spline_vars)
```

