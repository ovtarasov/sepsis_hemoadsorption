---
title: "Обсуждение финального проекта в ИБ # 5"  
author: "Олег Тарасов"  
date: "2024-12-15"  
---

### Анализ выживаемости

*Никита* -- сделан анализ выживаемости  

**NB!** Отфильтровать данные по точке 0  

Пока что -- Каплан-Майер, сделать тест Грея  

Индикаторная переменная -- продолжительность шока + продолжительность нахождения в реанимации  

Те, у кого не было шока -- исключаем из анализа  

### Подготовка к предзащите  

Что должно быть в презентации:  
- эпидемиологическая история  
    - пациенты с сепсисом, есть/нет септического шока, возраст от 18 лет, исключения: беременность, рак не в стадии ремиссии (+ мб более строгие критерии в рандомизированном КИ)  
    - терапия: стандартная по клиническим рекомендациям / + двукратная гемосорбция (в точке 0 -- от 4 часов до суток по решению врача, вторая -- начинается через 24 часа после начала первой); пациенты без второй терапии (из-за смерти / значимого улучшения состояния) НЕ исключены; сорбент -- эфферон   

- дизайн исследования -- рандомизация в одном исследовании, еще в одном -- проспективно "как повезло" (но м.б. bias из-за тяжести состояния пациента), в оставшихся -- контроль ретроспективный по картам в соответствии с критериями включения  
    **NB!** Из-за правил Минздрава на *уже зарегистрированное изделие* сложно получить разрешение на рандомизированное исследование (+ этические соображения)  

- предобработка и какие были ошибки в данных / проблемы  

- статистические и клинические гипотезы, методы для проверки:  
    - сопоставимость групп  
    - влияние сорбции на скорость выздоровления и частоту разрешения шока + летальность;  
    - если влияние есть -- то с какими показателями это связано (интерлейкины -- в части исследований, разрешение шока -- снижение SOFA, дозы вазопрессоров)  
    - есть ли группы пациентов, которым гемосорбция поможет с большей/меньшей вероятностью -- клинические рекомендации для применения  

- дальнейшие планы  

[Папка для презентации](https://drive.google.com/drive/folders/1VindsO1A-hGRWgKLQYYwhUzBEXDT4Zlt)  

### Организационное  

Далее к предзащите:  
- Никита -- анализ выживаемости  
- Настя -- дизайн исследования, вводная часть  
- Олег, Вика -- EDA + flowchart  

*Олег* -- переделать структуру гита  

По презентации: четверг 20:00 Мск прогон  

-----
*Добавлено после обсуждения*  

### Идеи по организации репозитория и кода от Олега  

1. Структура папок:  

Предлагаю такую структуру репозитория:  

```
sepsis_HA/
├── abandoned/
│   ├── _anastasia
│   ├── _nikita
│   ├── _oleg
│   └── _victoria
├── code/
│   ├── DAG
│   ├── scripts/
│   │   └── *.R
│   └── *.Rmd
├── data/
│   ├── processed/
│   │   └── *.rds
│   └── raw/
│       └── sepsis_HA_df_v3.rds
├── discussions
├── figures
├── reports
├── project.Rproj
├── README.md
└── render_report.R
```

- [`abandoned`](../abandoned/) -- временная папка, чтобы спрятать уже существующие наши личные подпапочки; к концу работы над проектом нужно будет удалить; ничего важного по проекту не храним; добавил её в [`.gitignore`](../.gitignore)  
- [`code`](../code/) -- весь код; в корне папки -- `*.Rmd` блокноты  
    - [`code/DAG`](../code/DAG/) -- здесь модель DAG (а картинка -- в `figures`)  
    - [`code/scripts`](../code/scripts/) -- здесь вынесенные отдельно `*.R` скрипты  
- [`data`](../data/) -- данные:  
    - [`data/processed`](../data/processed/) -- то, что получается в ходе нашей работы (например, при первичной очистке датасета) в формате `*.rds`  
    - [`data/raw`](../data/raw) -- исходники (на данный момент `sepsis_HA_df_v3.rds`)  
- [`discussions`](../discussions) -- конспекты наших обсуждений
- [`figures`](../figures/) -- сюда складываем рисунки  
- [`reports`](../reports) -- предлагаю для срендеренных отчетов сделать отдельную папку; в том числе сюда пойдет и итоговый отчет. Пока не понял, можно ли это делать автоматически через RStudio   
- [`project.Rproj`](../project.Rproj) -- файл проекта; прошу пока не переименовывать, это мне нужно для синхронизации с Posit.cloud  
- [`README.md`](../README.md) -- описание репозитория  
- [`render_report.R`](../render_report.R) -- скрипт для верстки отчетов; пока в черновом варианте  

2. Предлагаю начинать название каждого файла с префикса `sepsis_HA_`, чтобы они идентифицировались с этим проектом и не путались с возможными одноименными файлами из других папок.  

3. Для адресации файлов внутри пакета предлагаю использовать функции из `library(here)` ( описание см. [тут](https://here.r-lib.org/articles/rmarkdown.html) ):  
- `here::i_am("path_to_this_file")` -- декларируется в начале скрипта / первом чанке Rmd, в качестве аргумента указывается путь к самому этому файлу **относительно корневой папки проекта**  
- `here::here()` -- при обращении к другим файлам и папкам того же проекта, путь до них **относительно корневой папки проекта** указывается внутри функции  

*Пример*:  

Для структуры проекта  

```
Project/
├── data/
│   └── data.rds
└── script.R
```

Адресация внутри скрипта выглядит как  

```
here::i_am("script.R")  
data <- readRDS(here::here("data/data.rds"))
```

4. Особенности `*.Rmd` файлов:  

Как я уже говорил, мне кажется, что стоит каждый внутренне полный блок анализа писать в отдельный `*.Rmd`. При этом, как говорил на лекции Кирилл, поле даты в первом yaml-блоке заполнять не надо (ни фиксированно, ни с помощью `r Sys.Date()`), т.к. изменение *только* даты в `html` тоже будет отслеживаться гитом и создавать ненужные обновления  

Еще есть мысль, что по мере того, как становится понятен порядок анализа данных, можно добавлять в начале названия каждого Rmd файла префикс-номер: 0 -- общий файл-сборщик, 1 -- очистка данных и EDA, 2 -- сводные таблицы по показателям и т.д.  

В конце все можно будет собрать в единый отчет одним скриптом.  

Мои настройки в первом чанке каждого Rmd:

```{r setup, include = FALSE}
# Set default chunk options

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = TRUE)

# Set working folders

here::i_am("code/1_sepsis_HA_data_import_processing.Rmd")

path_to_scripts = "code/scripts"
path_to_data = "data"

# Load required libraries

# Load external scripts

```

Я стараюсь давать каждому чанку уникальное человекочитаемое название -- это м.б. полезно, если потом адресоваться к ним по отдельности.  

В своем коде я подгружаю данные из файлов `*.rds` в переменные, названия которых по скриптам унифицированы. Если данные изменяются и эти изменения нужны для дальнейшей работы, то сохраняю их в новый `here::here(path_to_data, "processed/sepsis_HA_df_*.rds"))`. Если кусок кода может работать как автономно, так и в пайплайне с другими, то *в некоторых случаях* можно поставить проверку на наличие датасета в окружении -- но тут надо хорошо продумывать, где это можно безопасно делать с точки зрения воспроизводимости; пока что мне кажется, что практически всегда лучше пройти через сохранение-чтение файла. Такое я реализовал только в скриптах первого этапа по очистке-фильтрации данных:  

- Проверка наличия `*.rds`: если есть нужный файл, переменная читается из файла; если нет -- выполняется скрипт по его созданию:  

```
if (file.exists(here::here(path_to_data, "processed/sepsis_HA_df_cleaned.rds"))) {
  # Load cleaned data from existing file
  sepsis_HA_df_cleaned <- readRDS(here::here(path_to_data, "processed/sepsis_HA_df_cleaned.rds"))
  print("Очищенные данные прочитаны из ранее созданного файла")
} else {
  # If `data/processed/sepsis_HA_df_cleaned.rds` does not exist, run `code/scripts/sepsis_HA_data_import_cleaning.R` for data reading and primary processing
  source(here::here(path_to_scripts, "sepsis_HA_data_import_cleaning.R"))  
  print("Проведена очистка данных")
}
```

- Проверка наличия переменной в окружении: если её нет, то прочитать из файла:  

```
if (!exists("sepsis_HA_df_cleaned")) { sepsis_HA_df_cleaned <- readRDS(here::here("data/processed/sepsis_HA_df_cleaned.rds")) }
```

5. Думаю, что стоит устанавливать все пакеты через `renv::install()`, как Кирилл рассказывал на лекции про ГитХаб.  

6. Раз уж мы пытаемся работать с репозиторием, то надо **не забывать создавать-сливать ветки!!!**. И дописывайте, пожалуйста, информацию о добавленных файлах в `README_*.md` в соответствующих папках, желательно по-английски.

7. С учетом того, что Наташа сегодня ответила на мой вопрос про язык на защите, предлагаю комментарии в коде писать по возможности по-английски, а текст в Rmd, наверное, всё же оставить русский (чтобы был на всякий случай русскоязычный отчет; тезисы все равно писать в конце отдельно). Что делать с текстом на картинках, пока не придумал; возможно, тоже стоит сразу делать по-английски, но после предзащиты попробую написать гайдлайн и скрипт, как генерировать сразу двуязычные -- есть идея на этот счет.  