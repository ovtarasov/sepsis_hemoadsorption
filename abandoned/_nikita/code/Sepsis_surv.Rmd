---
title: "Survival analysis"
author: "Гладышев Никита Сергеевич"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library (dplyr)
library(tidycmprsk)
library(ggplot2)
library(ggsurvfit)

```


# 3. Анализ выживаемости

## 3.1 Предобработка

```{r}
# Формируем уникальные ID, делаем переменные "смерть, выздоровление и цензурирование"

sepsis_clear <- readRDS("../../../../sepsis_clear_GNS.rds") %>%
  mutate(
    unique_patient_id = paste(study_id, study_patient_id, sep = "_"),
    event_status = case_when(
      shock_first_end_status == "death" ~ "death",
      shock_first_end_status == "recovery" ~ "recovery",
      is.na(shock_first_end_status) ~ "censored"
    ),
    event_time = shock_dur_T0_first_end
  ) %>%
  mutate(event_status = factor(event_status, levels = c("censored", "recovery", "death")),
         across(where(is.character), as.factor))
# Делаем датафрейм с 
sepsis_single <- sepsis_clear %>%
  group_by(unique_patient_id) %>%
  summarise(
    treatment = first(treatment),
    event_status = first(event_status),
    event_time = if_else(all(is.na(event_time)), NA_real_, max(event_time, na.rm = TRUE))
  ) %>%
  ungroup()


```

## 3.2 Анализ выживаемости и визуализация исхода: смерть

```{r}

cuminc(Surv(event_time, event_status) ~ treatment, data = sepsis_single) %>%
  ggcuminc(outcome = "death") +
  labs (title = "Кумулятивный риск смерти",
        y = "Кумулятивная вероятность",
        x = "Время",
        color = "Группа лечения") + 
  add_confidence_interval() +
  add_risktable() +
  theme_bw ()

```

## 3.3 Анализ выживаемости и визуализация исхода: выздоровление


```{r}
cuminc(Surv(event_time, event_status) ~ treatment, data = sepsis_single) %>%
  ggcuminc(outcome = "recovery") +
  labs(
    title = "Кумулятивный риск выздоровления",
    x = "Время",
    y = "Кумулятивная вероятность",
    color = "Группа лечения"
  ) + 
  add_confidence_interval() +
  add_risktable() +
  theme_bw ()
```





