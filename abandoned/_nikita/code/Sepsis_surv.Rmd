---
title: "Survival analysis"
author: "Гладышев Никита Сергеевич"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidycmprsk)
library(ggplot2)
library(ggsurvfit)

```


# 3. Анализ выживаемости

## 3.1 Предобработка

```{r}
# Формируем уникальные ID
sepsis_clear <- readRDS("../../../../sepsis_clear_GNS.rds")
sepsis_clear <- sepsis_clear %>%
  mutate(unique_patient_id = paste(study_id, study_patient_id, sep = "_"))

#Делаем переменные для АВ

sepsis_clear <- sepsis_clear %>%
  mutate(
    event_status = case_when(
      shock_first_end_status == "death" ~ 1,
      shock_first_end_status == "recovery" ~ 0
    ),
    event_time = shock_dur_T0_first_end
  ) %>%
  mutate(across(where(is.character), as.factor))


# Группируем пациента по времени наступления смерти

sepsis_single <- sepsis_clear %>%
  group_by(unique_patient_id) %>%
  summarise(
    treatment = first(treatment),
    event_status = max(event_status, na.rm = TRUE),
    event_time = max(event_time, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  mutate(event_status = factor(event_status, levels = c(0, 1), labels = c("censored", "death")))

# Группируем пациента по времени наступления выздоровления

sepsis_recovery <- sepsis_clear %>%
  mutate(
    event_status = case_when(
      shock_first_end_status == "recovery" ~ 1,
      shock_first_end_status == "death" ~ 0
    )
  ) %>%
  group_by(unique_patient_id) %>%
  summarise(
    treatment = first(treatment),
    event_status = max(event_status, na.rm = TRUE),
    event_time = max(event_time, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  mutate(event_status = factor(event_status, levels = c(0, 1), labels = c("censored", "recovery")))

```

## 3.2 Анализ выживаемости и визуализация исхода: смерть

```{r}

cuminc(Surv(event_time, event_status) ~ treatment, data = sepsis_single) %>%
  ggcuminc(outcome = "death") +
  labs (title = "Кумулятивный риск смерти",
        y = "Кумулятивная вероятность",
        x = "Время",
        color = "Группа лечения") + 
  add_confidence_interval() +
  add_risktable() +
  theme_bw ()

```

## 3.3 Анализ выживаемости и визуализация исхода: выздоровление

#3.4 Модель пропорциональных рисков Кокса

```{r}
cuminc(Surv(event_time, event_status) ~ treatment, data = sepsis_recovery) %>%
  ggcuminc(outcome = "recovery") +
  labs(
    title = "Кумулятивный риск выздоровления",
    x = "Время",
    y = "Кумулятивная вероятность",
    color = "Группа лечения"
  ) + 
  add_confidence_interval() +
  add_risktable() +
  theme_bw ()
```
##3.5 Визуализация




